# Varnish VCL include file for mobile backends

sub vcl_recv {
	if (req.http.host ~ "^([a-zA-Z0-9-]+)\.(m|zero|wap|mobile)\.") {
		call vcl_recv_purge;
	}
	elsif (req.request == "PURGE") {
		error 200 "Domain not cached here.";
	}

	if ( req.http.host ~ "^test\." ) {
		set req.backend = test_wikipedia;
		return (pass);
	}
	if (req.url ~ "^/w/api.php") {
		set req.backend = api;
	}
}

sub vcl_fetch {
	if (req.url ~ "mobileaction=" || req.url ~ "useformat=") {
		set beresp.ttl = 60 s;
	}
}
