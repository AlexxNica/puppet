# Varnish VCL include file for mobile backends

include "errorpage.inc.vcl";

sub vcl_recv {
	call vcl_recv_purge;
	/* FIXME: restrict access */

	if ( req.http.host ~ "^test\." ) {
<% if vcl_config.fetch("cluster_tier", "1") == "1" -%>
		set req.backend = test_wikipedia;
<% end -%>
		return (pass);
	}
<% if vcl_config.fetch("cluster_tier", "1") == "1" -%>
	if (req.url ~ "^/w/api.php") {
		set req.backend = api;
	}
<% end -%>
}

sub vcl_fetch {
	if (req.url ~ "mobileaction=" || req.url ~ "useformat=") {
		set beresp.ttl = 60 s;
	}
}

sub vcl_error {
	call errorpage;
	return(deliver);
}
