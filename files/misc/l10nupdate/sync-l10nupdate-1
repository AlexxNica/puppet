#!/bin/bash
# This script belongs in /usr/local/bin/.
. /etc/profile.d/mediawiki.sh

MWVER="$1"
MW_RSYNC_HOST="tin.eqiad.wmnet"

if [ -z "$MWVER" ]; then
	echo "FAILED: MediaWiki version not provided"
	exit 1
fi

echo "Synchronizing $MEDIAWIKI_STAGING_DIR/php-$MWVER/cache/l10n to $MEDIAWIKI_DEPLOYMENT_DIR/php-$MWVER/cache/l10n..."
echo "mediawiki-installation:"

# Set forklimit to 30 (-F 30) to prevent NFS from getting overloaded causing some machines to be skipped
dsh -o -oPasswordAuthentication=no -F 30 -cM -g mediawiki-installation \
  "sudo -u mwdeploy rsync -a $MW_RSYNC_HOST::common/php-$MWVER/cache/l10n/ $MEDIAWIKI_DEPLOYMENT_DIR/php-$MWVER/cache/l10n"
