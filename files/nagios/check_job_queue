#!/bin/sh
# nagios plugin to check the mediawiki job queue

LARGEQUEUES=
php /home/wikipedia/common/multiversion/MWScript.php extensions/WikimediaMaintenance/getJobQueueLengths.php | sort -n | while read wiki count; do
	if [ ! $(echo "$count" | grep -E "^[0-9]+$") ]; then
		echo "JOBQUEUE CRITICAL - check plugin (`basename $0`) or PHP errors - $wiki"
		exit 2
	elif [ $count -gt 9999 ]; then
		LARGEQUEUES="$LARGEQUEUES, $wiki ($count)"
	fi
done
if [ -z $LARGEQUEUES ]; then
	echo "JOBQUEUE OK - all job queues below 10,000"
	exit 0
else
	echo "JOBQUEUE CRITICAL - the following wikis have more than 9,999 jobs: $LARGEQUEUES"
	exit 2
fi
