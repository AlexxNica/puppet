#!/bin/sh

# This is based on geoip-database-contrib_update from Debian's
# geoip-database-contrib package. The original source can be found at
# http://git.debian.org/?p=collab-maint/geoip-database-contrib.git
# and is
# Copyright: 2010/2013, Ludovico Cavedon <cavedon@debian.org>
#                       Patrick Matth√§i <pmatthaei@debian.org>
# License: GPL-2+
#
# It was modified by Faidon Liambotis for use by the Wikimedia Foundation

DESTDIR=$1
if [ ! -d "$DESTDIR" ]; then
	echo "Usage: $0 <destdir>"
	exit 1
fi

GEOIP_URL="http://geolite.maxmind.com/download/geoip/database"

FAILED=0

for url in \
    "$GEOIP_URL/GeoLiteCountry/GeoIP.dat.gz" \
    "$GEOIP_URL/GeoIPv6.dat.gz" \
    "$GEOIP_URL/GeoLiteCity.dat.gz" \
    "$GEOIP_URL/GeoLiteCityv6-beta/GeoLiteCityv6.dat.gz" \
    "$GEOIP_URL/asnum/GeoIPASNum.dat.gz" \
    "$GEOIP_URL/asnum/GeoIPASNumv6.dat.gz" \
    "$GEOIP_URL/GeoLite2-Country" \
    "$GEOIP_URL/GeoLite2-City.mmdb.gz"
do
    echo "Downloading: $url"

    # Download file in the same directory as the final one so that the "mv"
    # below can be atomic.
    TEMPGZ=$(mktemp --tmpdir=$DESTDIR/ --suffix=.gz)
    TEMP=${TEMPGZ%.gz}
    FILEGZ=$(basename $url)
    FILE=${FILEGZ%.gz}

    # MaxMind is being totally inconsistent and names both GeoIP Country and
    # GeoLite Country with the same file. Explicitly rename this to
    # GeoLite.dat, so that we can happily coexist with geoipupdate.
    case "$FILE" in
        GeoIP.dat)
            FILE="GeoLite.dat"
            ;;
    esac

    /usr/bin/wget -q -t3 -T15 "$url" -O $TEMPGZ

    if [ "$?" != "0" ]
    then
        echo "Failed to download $url"
    else
        /bin/gunzip -f $TEMPGZ

        if [ "$?" != "0" ]
        then
            echo "Failed to decompress $FILEGZ"
        else
            rm -f $DESTDIR/$FILE
            mv $TEMP $DESTDIR/$FILE
            chmod 644 $DESTDIR/$FILE
        fi
    fi

    rm -f $TEMP $TEMPGZ
done

exit 0
