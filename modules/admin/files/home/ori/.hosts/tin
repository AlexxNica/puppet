#!/bin/bash

. /usr/local/lib/mw-deployment-vars.sh

looksgood () {
    ( git remote -v | grep -q mediawiki-config ) && { git merge origin/master; return; }
    dir=$(pwd)
    branch="${dir#/srv/mediawiki-staging/php-}"
    git rebase origin/wmf/$branch
}

fetch() {
    cd "$MEDIAWIKI_STAGING_DIR"
    if [ "$1" = "config" ]; then
        cd wmf-config
        git fetch origin
        git diff HEAD origin
    else
        branch_dir=$(find . -maxdepth 1 -type d -iregex "./php-[0-9.]+wmf$1")
        branch="origin/wmf/${branch_dir#./php-}"
        cd "${branch_dir}"
        git fetch
        git log HEAD..${branch}
    fi
}

cdbranch() {
    cd "$MEDIAWIKI_STAGING_DIR"
    branch_dir=$(find . -maxdepth 1 -type d -iregex "./php-[0-9.]+wmf$1")
    cd "${branch_dir}"
}

bump() {
    git submodule update --init --recursive extensions/$1
}

deploy() {
    pushd /srv/deployment/$1/* &>/dev/null && (
      git deploy finish
      [ "$1" = "--no-update" ] || { git fetch; git checkout origin/master; }
      git deploy start
    ) &>/dev/null && (
      yes | git deploy sync 2>&1 | grep completed
    ) && { popd &>/dev/null; notice "Ok."; } || warn "Failed."
}
