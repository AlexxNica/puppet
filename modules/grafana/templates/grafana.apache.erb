# Apache configuration for Grafana.
# This file is managed by Puppet.
<VirtualHost <%= @listen %>>
  ServerName <%= @server_name %>
  DocumentRoot /srv/deployment/grafana/grafana/dist

  <Directory />
    AllowOverride None
  </Directory>

  <Location />
    <Limit POST PUT DELETE>
      AuthName "<%= @auth_ldap['name'] %>"
      AuthType Basic
      AuthBasicProvider ldap
      AuthLDAPBindDN <%= @auth_ldap['bind_dn'] %>
      AuthLDAPBindPassword <%= @auth_ldap['bind_password'] %>
      AuthLDAPURL "<%= @auth_ldap['url'] %>"
      <% @auth_ldap['groups'].each do |group| -%>
      Require ldap-group <%= group %>
      <% end -%>
    </Limit>
  </Location>

  <Directory /srv/deployment/grafana/grafana/dist>
    AllowOverride None
    <IfVersion >= 2.4>
      Require all granted
    </IfVersion>
    <IfVersion < 2.4>
      Order deny,allow
      Allow from all
    </IfVersion>
  </Directory>

  <Directory /etc/grafana>
    <IfVersion >= 2.4>
      Require all granted
    </IfVersion>
    <IfVersion < 2.4>
      Allow from all
    </IfVersion>
  </Directory>

  <%- if @elastic_backends -%>
  <LocationMatch ^(/grafana-dashboards/.*)$>
    ProxyPassMatch balancer://elastic$1
    Header set Cache-Control no-cache
  </LocationMatch>
  ProxyPassReverse /grafana-dashboards balancer://elastic

  <Proxy balancer://elastic>
  <%- @elastic_backends.each do |backend| -%>
    BalancerMember <%= backend %>
  <%- end -%>
  </Proxy>
  <%- end -%>

  Alias /config.js /etc/grafana/config.js
</VirtualHost>
